<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Assigment</title>
    <link rel="stylesheet" href="index.css">

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        th, td, p, input {
            font:14px Verdana
        }
        table, th, td
        {
            border: solid 1px #DDD;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
            background-color:  #d9b3fd;
        }
        th {
            font-weight:bold;
        }
    </style>
</head>
<body>
<h1>Reddit posts</h1>
<button id="paginate left" class="" ></button>
<button id="paginate right"></button>
<button id="showposts"  >All posts</button>
<div class="modal">
    <h1>Filter</h1>
    <form id="filterform">
        <input type="text" placeholder="category" id="postcategory" pattern="r/[\w]*"><br>
        <input type="text" placeholder="date min" id="date-min" pattern="\d{4}-\d{2}-\d{2}">
        <input type="text" placeholder="date max" id="date-max" pattern="\d{4}-\d{2}-\d{2}"><br>
        <input type="text" placeholder="number of votes min" id="numberofvotes-min" pattern="\d*">
        <input type="text" placeholder="number of votes max" id="numberofvotes-max" pattern="\d*"><br>
        <input type="submit" onclick="filterArgs()" value="OK">
     </form>
 </div> 
<div id="widgets"></div>
<script type="text/babel">
    let state = {
        buttonOption: false,
    }
    let limit=10
    let offset=0
    let count_of_posts=0
    let firstList = []
    let url= new URL("http://localhost:8087/posts/?limit=10&offset=0")
    let posts_url= new URL("http://localhost:8087/posts/")
    //pagination
    function slide(delta) {
        offset+=delta
        url.searchParams.set('offset',offset)
        let req2 = new XMLHttpRequest()
        req2.open('GET', url,true )
        req2.send()
        req2.onreadystatechange = function() {
        if(req2.readyState!=4){
            return
        }
        firstList=JSON.parse(req2.responseText)
        render_page()
        }  
    }       
    if(!state.buttonOption){
        let pr = document.getElementById('paginate left')
        let pl = document.getElementById('paginate right')
        pr.onclick = () => slide(-limit )
        pl.onclick = () => slide( limit )
        slide(0)
    } 
    //filters
    function filterArgs(){
        let filter_url=new URL(url)
        if (state.buttonOption){
           filter_url= new URL(posts_url)
        }
        if (document.getElementById("postcategory").value){
            if (filter_url.searchParams.has('category')){
                filter_url.searchParams.append('category',document.getElementById("postcategory"))
            }
            filter_url.searchParams.set('date_min',getElementById("date-min"))
        }
        if (document.getElementById("date-min").value){
            if (filter_url.searchParams.has('date_min')){
                filter_url.searchParams.append('date_min',getElementById("date-min"))
            }
            filter_url.searchParams.set('date_min',getElementById("date-min"))
        }
        if (document.getElementById("date-max").value){
            if (filter_url.searchParams.has('date_max')){
                filter_url.searchParams.append("date_max="+ document.getElementById("date-max").value)
            }
            filter_url.searchParams.set("date-max",document.getElementById("numberofvotes-min").value)
        }
        if (document.getElementById("numberofvotes-min").value){
            if (filter_url.searchParams.has('votes_min')){
                filter_url.searchParams.append("votes_min",document.getElementById("numberofvotes-min").value)
            }
            filter_url.searchParams.set("votes_min",document.getElementById("numberofvotes-min").value)
        }
        if(document.getElementById("numberofvotes-max").value){
            if (filter_url.searchParams.has('votes_max')){
                filter_url.searchParams.append("votes_max",document.getElementById("numberofvotes-max").value)
            }
            filter_url.searchParams.set("votes_max",document.getElementById("numberofvotes-max").value)
        }
        let req2 = new XMLHttpRequest()
        req2.open('GET', filter_url,true )
        req2.send()
        req2.onreadystatechange = function() {
            if(req2.readyState!=4){
                return
            }
            firstList=JSON.parse(req2.responseText)
            count_of_posts=firstList.length
            render_page()
        }   
    }
    const form=document.getElementById("filterform")
    var modal = document.querySelector('.modal')
    var overflow = document.createElement('div')
    function openWin() {
        overflow.className = "overflow"
        document.body.appendChild(overflow)
        var height = modal.offsetHeight
        modal.style.marginTop = - height / 2 + "px"
        modal.style.top = "50%"
    }
    if (!Element.prototype.remove) {
        Element.prototype.remove = function remove() {
                if (this.parentNode) {
                        this.parentNode.removeChild(this)
                }
        }
    }
    overflow.onclick = function () {
        modal.style.top = "-100%"
        overflow.remove()
    } 
    //showall
    function getElements(event){
        limit=10
        offset=0
        state.buttonOption = !state.buttonOption
        let req = new XMLHttpRequest()
        req.open('GET', posts_url,true )
        req.send()
        req.onreadystatechange = function() {
            if(req.readyState!=4){
                return
            }
            firstList=JSON.parse(req.responseText)
            render_page()
        }   
    }
    let sendButton= document.getElementById("showposts")
    sendButton.addEventListener("click", getElements)
    //react components
    const Container = () => {
        return (
            <div >
                <table >
                    <thead>
                        <tr>
                            <th>POST URL</th>
                            <th>USERNAME</th>
                            <th>USER KARMA</th>
                            <th>USER CAKE DAY</th>
                            <th>POST KARMA</th>
                            <th>COMMENTS KARMA</th>
                            <th>POST DATE</th>
                            <th>NUMBER OF COMMENTS</th>
                            <th>NUMBER OF VOTES</th>
                            <th>POST CATEGORY</th>
                        </tr>
                    </thead>
                    <tbody>
                    { 
                        firstList.map((item) =>{
                        return(
                            <tr key={item.uniqueId}>
                                <td>{item.postUrl}</td>
                                <td>{item.username}</td>
                                <td>{item.userKarma}</td>
                                <td>{item.userCakeDay}</td>
                                <td>{item.postKarma}</td>
                                <td>{item.commentKarma}</td>
                                <td>{item.postDate}</td>
                                <td>{item.numberOfComments}</td>
                                <td>{item.numberOfVotes}</td>
                                <td>{item.postCategory}</td>
                            </tr>
                        )
                        }
                        )
                    }
                </tbody>
                </table>
            </div>
        )
    }
    const Button = ({onClick}) => {
        return (
            <button onClick={onClick}>
                <div>
                    Choose filter
                </div>
            </button>
        )
    }
    
    const Wrapper = () => (
        <div >
            <Button 
                onClick={openWin} 
                />
            <Container />
        </div>
    )
    function render_page(){
        ReactDOM.render(
            <Wrapper/>,
            document.getElementById('widgets')
        )
    }
</script>
</body>
</html>